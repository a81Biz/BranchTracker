name: Sync master with prod and delete feature branch

on:
  workflow_run:
    workflows: ["Deploy to Production"]
    types:
      - completed

jobs:
  sync-master:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout prod branch
        uses: actions/checkout@v4
        with:
          ref: prod

      - name: Checkout master branch
        run: |
          git fetch origin master
          git checkout master

      - name: Merge prod into master
        run: |
          git merge prod --allow-unrelated-histories

      - name: Push to master
        run: |
          git push origin master

      - name: Get the branch name from pull request
        id: get_branch_name
        run: |
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          echo "Branch Name: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Get latest commit hash from the branch that made the PR
        id: get_commit
        run: |
          COMMIT_HASH=$(git rev-parse origin/${{ env.branch_name }})
          echo "Commit Hash: $COMMIT_HASH"
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_ENV

      - name: Validate commit matches and delete branch
        run: |
          LATEST_COMMIT=$(git rev-parse origin/${{ env.branch_name }})
          if [ "$LATEST_COMMIT" == "${{ env.commit_hash }}" ]; then
            if [ "${{ env.branch_name }}" != "master" ] && [ "${{ env.branch_name }}" != "prod" ] && [ "${{ env.branch_name }}" != "uat" ]; then
              echo "Commit matches. Deleting branch ${{ env.branch_name }}."
              echo "git push origin --delete ${{ env.branch_name }}"
            else
              echo "Skipping deletion of protected branch ${{ env.branch_name }} (master, prod, uat)."
            fi
          else
            echo "Commit does not match. Skipping branch deletion."
          fi